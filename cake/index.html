<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>Konva Drop Events Demo</title>
		<script src="https://tw.hicdn.beanfun.com/plugins/isMobile/isMobile.min.js"></script>
		<script src="https://tw.hicdn.beanfun.com/jquery/jquery.min.js"></script>
		<script src="https://tw.hicdn.beanfun.com/jquery/jquery-migrate.min.js"></script>
		<script src="https://tw.hicdn.beanfun.com/plugins/konva/8.1.3/konva.min.js"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
				overflow: hidden;
				background-color: #f0f0f0;
				box-sizing: border-box;
			}
			#container {
				/* border: 1px solid #000; */
				display: inline-block;
				vertical-align: top;
			}
			.deco-box {
				display: inline-block;
				vertical-align: top;
			}
			#touchImg {
				position: absolute;
				transition: opacity 0.2s;
			}
			@media screen and (max-width: 768px) {
				[data-id="banana1"] {
					width: calc(88 / 768 * 100vw);
				}
				[data-id="bean"] {
					width: calc(64 / 768 * 100vw);
				}
				[data-id="bow"] {
					width: calc(99 / 768 * 100vw);
				}
			}
		</style>
	</head>
	<body>
		<div id="container"></div>
		<div class="deco-box">
			<img data-id="banana1" class="img" src="./images/deco/banana1.png" alt="" draggable="true" />
			<img data-id="bean" class="img" src="./images/deco/bean.png" alt="" draggable="true" />
			<img data-id="bow" class="img" src="./images/deco/bow.png" alt="" draggable="true" />
		</div>
		<script>
			var scale = window.innerWidth > 768 ? 1 : window.innerWidth / 768;
			var canvasWidth = window.innerWidth > 768 ? 768 : window.innerWidth;
			var canvasHeight = window.innerWidth > 768 ? 604 : 604 * scale;

			// 預載load圖片
			var imgs = ["./images/static/cream.png", "./images/cake/firework.png", "./images/cake/grid.png", "./images/cake/marble.png", "./images/cake/rock.png", "./images/cake/sea.png", "./images/cake/white.png", "./images/cake/wood1.png", "./images/cake/wood2.png", "./images/deco/banana1.png", "./images/deco/bean.png", "./images/deco/blue.png", "./images/deco/bow.png", "./images/deco/candle0.png", "./images/deco/candle1.png", "./images/deco/candle11.png", "./images/deco/red.png", "./images/deco/yellow.png", "./images/static/dish.png", "./images/static/remove-icon.png"];
			function preloadImage() {
				imgs.forEach(function (src, i) {
					var imgObj = new Image();
					imgObj.src = src;
				});
			}
			preloadImage();

			var stage = new Konva.Stage({
				container: "container",
				width: canvasWidth,
				height: canvasHeight,
			});
			var cakeGroup = new Konva.Group({
				y: canvasHeight - 369 * scale,
				name: "cakeGroup",
				id: "cakeGroup",
			});
			var layer = new Konva.Layer();
			var decoLayer = new Konva.Layer();

			layer.add(cakeGroup);
			stage.add(layer);
			var tempLayer = new Konva.Layer();
			stage.add(tempLayer);
			// 垃圾桶
			function removeIcon() {
				var imageObj1 = new Image();
				imageObj1.src = "./images/static/remove-icon.png";
				imageObj1.onload = function () {
					var removeIcon = new Konva.Image({
						x: canvasWidth - 8 * scale - this.width * scale,
						y: canvasHeight - this.height * scale,
						width: this.width * scale,
						height: this.height * scale,
						name: "remove",
						id: "remove",
						zIndex: 2,
						src: "./images/static/remove-icon.png",
					});
					layer.add(removeIcon);
					removeIcon.image(imageObj1);
				};
			}
			removeIcon();
			// 一層透明背景
			function rect() {
				var box = new Konva.Rect({
					x: 0,
					y: 0,
					width: window.innerWidth > 768 ? 768 : window.innerWidth,
					height: 562 * scale,
					id: "box",
					name: "rect",
				});
				layer.add(box);
			}

			// 底盤
			function dish() {
				var dish = new Konva.Image({
					x: canvasWidth / 2 - (684 * scale) / 2,
					y: 100 * scale,
					width: 684 * scale,
					height: 231 * scale,
					name: "dish",
					id: "dish",
					zIndex: 2,
					src: "./images/static/dish.png",
				});
				cakeGroup.add(dish);
				var imageObj1 = new Image();
				imageObj1.onload = function () {
					dish.image(imageObj1);
				};
				imageObj1.src = "./images/static/dish.png";
			}
			// 奶油層
			function cream() {
				var cream = new Konva.Image({
					x: canvasWidth / 2 - (515 * scale) / 2,
					y: -60 * scale,
					width: 515 * scale,
					height: 247 * scale,
					name: "cream rage",
					id: "cream",
					zIndex: 2,
					src: "./images/static/cream.png",
				});
				cakeGroup.add(cream);
				var imageObj1 = new Image();
				imageObj1.onload = function () {
					cream.image(imageObj1);
				};
				imageObj1.src = "./images/static/cream.png";
			}

			// 蛋糕底層
			function cakeStyle(attrs = { RGB: [], src: "./images/cake/white.png", id: "white" }) {
				var { RGB, src, id } = attrs;
				if (stage.find(".cake")[0]) {
					if (id == "cake-white") {
						if (RGB.length > 0) {
							filerImage(RGB);
							return;
						}
					}
					if (RGB) {
						if (RGB.length > 0 && stage.find(".cake")[0].getAttr("id") == "white") {
							filerImage(RGB);
							return;
						}
					}
					stage.find(".cake")[0].destroy();
				}
				var cake = new Konva.Image({
					x: canvasWidth / 2 - (475 * scale) / 2 + 2,
					y: 30 * scale,
					width: 475 * scale,
					height: 235 * scale,
					name: "cake range",
					src: src || "./images/cake/white.png",
					id: id || "cake-white",
				});
				dish();
				cakeGroup.add(cake);
				var imageObj1 = new Image();
				imageObj1.onload = function () {
					cake.image(imageObj1);
				};
				imageObj1.src = src || "./images/cake/white.png";
				cream();
				if (RGB) {
					if (RGB.length > 0 && stage.find(".cake")[0].getAttr("id") == "white") {
						setTimeout(() => {
							filerImage(RGB);
						}, 0);
						return;
					}
				}
			}
			function filerImage(RGB) {
				var shape = stage.find(".cake")[0];
				shape.cache();
				shape.filters([Konva.Filters.RGB]);
				shape["red"](RGB[0]);
				shape["green"](RGB[1]);
				shape["blue"](RGB[2]);
			}
			function decoImage(attrs) {
				var { x, y, id, width, height, src, scaleX, scaleY, skewX, skewY, rotation, zIndex, src } = attrs;
				var imageObj1 = new Image();
				imageObj1.src = src;
				imageObj1.onload = function () {
					var deco = new Konva.Image({
						x: x || 0,
						y: y || 0,
						width: width || this.width * scale,
						height: height || this.height * scale,
						name: "deco range",
						id: id,
						draggable: true,
						src: src,
						scaleX: scaleX || 1,
						scaleY: scaleY || 1,
						skewX: skewX || 0,
						skewY: skewY || 0,
						rotation: rotation || 0,
						dragBoundFunc: function (pos) {
							return {
								x: Math.max(0, Math.min(canvasWidth - this.attrs.width, pos.x)),
								y: Math.max(0, Math.min(canvasHeight - this.attrs.height, pos.y)),
								// x: pos.x < 0 ? 0 : pos.x > (matrix.row - this.attrs.width / blockSize) * blockSize ? (matrix.row - this.attrs.width / blockSize) * blockSize : pos.x,
								// y: pos.y < 0 ? 0 : pos.y > (matrix.col - this.attrs.height / blockSize) * blockSize ? (matrix.col - this.attrs.height / blockSize) * blockSize : pos.y,
							};
						},
					});
					layer.add(deco);
					deco.image(imageObj1);
				};

				if (zIndex) {
					stage.find("#" + id)[0].zIndex(zIndex);
				}
			}

			cakeStyle();
			var previousShape;
			var dragDeco;
			var trr;
			stage.on("tap", function (e) {
				if (e.target.attrs.name) {
					if (!e.target.attrs.name.match("deco")) {
						if (trr) {
							trr.destroy();
						}
						return;
					}
					if (trr) {
						trr.destroy();
					}
					var shape = stage.find("#" + e.target.attrs.id)[0];
					if (shape) {
						trr = new Konva.Transformer({
							nodes: [shape],
							centeredScaling: true,
						});
						layer.add(trr);
						trr.on("transform", function (e) {
							var width = e.target.width() * e.target.scaleX();
							if (width > 200) {
								trr.stopTransform();
								var scaleX = 200 / e.target.width();
								e.target.scaleX(scaleX);
							}
						});
					}
				} else {
					if (trr) {
						trr.destroy();
					}
				}
			});

			stage.on("dragstart", function (e) {
				e.target.moveTo(tempLayer);
				dragDeco = "";
				dragDeco = e.target.attrs.id;
			});
			stage.on("dragmove", function (evt) {
				var pos = stage.getPointerPosition();
				var shape = layer.getIntersection(pos);
				if (previousShape && shape) {
					if (previousShape !== shape) {
						// leave from old targer
						previousShape.fire(
							"dragleave",
							{
								type: "dragleave",
								target: previousShape,
								evt: evt.evt,
							},
							true
						);

						// enter new targer
						shape.fire(
							"dragenter",
							{
								type: "dragenter",
								target: shape,
								evt: evt.evt,
							},
							true
						);
						previousShape = shape;
					} else {
						previousShape.fire(
							"dragover",
							{
								type: "dragover",
								target: previousShape,
								evt: evt.evt,
							},
							true
						);
					}
				} else if (!previousShape && shape) {
					previousShape = shape;
					shape.fire(
						"dragenter",
						{
							type: "dragenter",
							target: shape,
							evt: evt.evt,
						},
						true
					);
				} else if (previousShape && !shape) {
					previousShape.fire(
						"dragleave",
						{
							type: "dragleave",
							target: previousShape,
							evt: evt.evt,
						},
						true
					);
					previousShape = undefined;
				}
				// stage.x = 300;
				// stage.y = 300;
			});
			stage.on("dragend", function (e) {
				var pos = stage.getPointerPosition();
				var shape = layer.getIntersection(pos);
				if (shape) {
					if (previousShape) {
						previousShape.fire(
							"drop",
							{
								type: "drop",
								target: previousShape,
								evt: e.evt,
							},
							true
						);
					}
				}
				previousShape = undefined;
				e.target.moveTo(layer);
				var shape = stage.find("#" + e.target.attrs.id)[0];
			});

			stage.on("dragenter", function (e) {});

			stage.on("dragleave", function (e) {});

			stage.on("dragover", function (e) {});

			stage.on("drop", function (e) {
				if (e.target.attrs.id == "remove") {
					// console.log(dragDeco);
					removeDeco(dragDeco);
				}
				dragDeco = "";
				// console.log("drop", e.target.attrs.id);
			});
			decoImage({ id: "blue1", src: "./images/deco/blue.png" });
			// decoImage({ id: "blue2", src: "./images/deco/blue.png" });
			// rect();
			// cakeBlue();
			// decoBlue();
			// decoRed();

			// 匯出base64
			function getDataUrl() {
				stage.toDataURL();
			}

			function loadInit() {
				rect();
				cakeBlue();
			}
			// 刪除單一
			function removeDeco(id) {
				setTimeout(() => {
					stage.find("#" + id)[0].destroy();
				}, 0);
			}
			// 清除畫面
			function reset() {
				if (stage.find(".cake")[0]) {
					cakeStyle();
				}
				if (stage.find(".deco")) {
					stage.find(".deco").forEach((d) => {
						d.destroy();
					});
				}
			}

			// 獲取所有config
			function getAllData() {
				var data = {
					cake: {},
					deco: [],
				};
				if (stage.find(".cake")[0]) {
					data.cake.id = stage.find(".cake")[0].getAttr("id");
					data.cake.src = stage.find(".cake")[0].getAttr("src");
				}
				if (stage.find(".deco").length) {
					stage.find(".deco").forEach((d) => {
						data.deco.push(d.getAttrs());
					});
				}
				console.log(data);
			}

			var touchImg;
			if (isMobile.any) {
				$(".img").on("touchstart", function (ev) {
					var e = ev.originalEvent;
					touchImg = $(e.target).clone();
					touchImg[0].setAttribute("id", "touchImg");
					touchImg[0].style.left = e.changedTouches[0].clientX - e.target.width / 2 + "px";
					touchImg[0].style.top = e.changedTouches[0].clientY - e.target.height / 2 + "px";
					$("body").append(touchImg);
				});
				$(".img").on("touchmove", function (ev) {
					var e = ev.originalEvent;
					document.getElementById("touchImg").style.left = e.changedTouches[0].clientX - e.target.width / 2 + "px";
					document.getElementById("touchImg").style.top = e.changedTouches[0].clientY - e.target.height / 2 + "px";
				});
				$(".img").on("touchend", function (ev) {
					var e = ev.originalEvent;
					document.getElementById("touchImg").style.left = e.changedTouches[0].clientX - e.target.width / 2 + "px";
					document.getElementById("touchImg").style.top = e.changedTouches[0].clientY - e.target.height / 2 + "px";
					document.getElementById("touchImg").style.opacity = 0;
					document.getElementById("touchImg").remove();
					drag(e.changedTouches[0]);
				});
			} else {
				$(".img").on("dragstart", function (e) {
					drag(e);
				});
			}
			window.addEventListener("touchstart", function (e) {});
			function drag(ev) {
				let r = Math.random().toString(36).substring(7);
				var obj = {
					x: ev.pageX - ev.target.width / 2,
					y: ev.pageY - ev.target.height / 2,
					src: ev.target.src,
					id: ev.target.dataset.id + r,
					width: ev.target.width,
					height: ev.target.height,
				};
				decoImage(obj);
			}
			// stage.find("#remove")[0].show()
			// stage.find("#remove")[0].hide()
		</script>
	</body>
</html>
