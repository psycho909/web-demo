<!DOCTYPE html>
<html>
	<head>
		<title>CSS Sprite Generator</title>
		<!-- Include CSS and JavaScript files here -->
		<style>
			.thumb {
				height: 75px;
				border: 1px solid #000;
				margin: 10px 5px 0 0;
			}
		</style>
	</head>
	<body>
		<div id="sprite-generator">
			<input type="file" id="image-upload" multiple />
			<div id="image-list"></div>
			<!-- Container for image thumbnails -->

			<select id="layout-options">
				<option value="horizontal">Horizontal</option>
				<option value="vertical">Vertical</option>
			</select>
			<input type="number" id="margin-size" placeholder="Margin size (px)" />
			<button id="generate-sprite">Generate Sprite</button>
			<div id="image-list"></div>
			<!-- Container for image thumbnails -->
			<a id="download-sprite" href="#" style="display: none">Download Sprite</a>
			<div id="sprite-preview"></div>
			<pre id="css-code"></pre>
		</div>
		<script>
			// Global Variables
			let spriteImages = [];
			let spriteCanvas, spriteCtx;

			// Event Listeners
			document.getElementById("image-upload").addEventListener("change", handleFileSelect, false);
			document.getElementById("generate-sprite").addEventListener("click", generateSprite);
			document.getElementById("layout-options").addEventListener("change", updateLayoutPreview);
			document.getElementById("margin-size").addEventListener("change", updateLayoutPreview);

			function handleFileSelect(evt) {
				let files = Array.from(evt.target.files);

				// Sort files by name
				files.sort((a, b) => a.name.localeCompare(b.name));

				// Clear previous images
				spriteImages = [];
				document.getElementById("image-list").innerHTML = "";

				// Create a promise for each file read
				let fileReadPromises = files.map((file) => {
					if (!file.type.match("image.*")) {
						return Promise.resolve(null); // Resolve non-image files immediately
					}

					return new Promise((resolve, reject) => {
						let reader = new FileReader();
						reader.onload = (e) => {
							let img = new Image();
							img.src = e.target.result;
							spriteImages.push(img);

							let thumbnailHtml = `<img class="thumb" src="${e.target.result}" title="${escape(file.name)}"/><br>${escape(file.name)}`;
							resolve(thumbnailHtml);
						};
						reader.onerror = reject;
						reader.readAsDataURL(file);
					});
				});

				// Wait for all files to be read
				Promise.all(fileReadPromises)
					.then((thumbnails) => {
						thumbnails.forEach((thumbnailHtml) => {
							if (thumbnailHtml) {
								// Only append if the file was an image
								let span = document.createElement("span");
								span.innerHTML = thumbnailHtml;
								document.getElementById("image-list").appendChild(span);
							}
						});
					})
					.catch((error) => {
						console.error("Error reading files:", error);
					});
			}

			function generateSprite() {
				if (spriteImages.length === 0) {
					alert("Please upload images first.");
					return;
				}

				let layout = document.getElementById("layout-options").value;
				let margin = parseInt(document.getElementById("margin-size").value) || 0;
				let spriteWidth = 0,
					spriteHeight = 0;

				if (layout === "horizontal") {
					spriteImages.forEach((img) => {
						spriteHeight = Math.max(spriteHeight, img.height);
						spriteWidth += img.width + margin;
					});
				} else {
					// Vertical
					spriteImages.forEach((img) => {
						spriteWidth = Math.max(spriteWidth, img.width);
						spriteHeight += img.height + margin;
					});
				}

				// Create canvas
				spriteCanvas = document.createElement("canvas");
				spriteCanvas.width = spriteWidth;
				spriteCanvas.height = spriteHeight;
				spriteCtx = spriteCanvas.getContext("2d");

				// Draw images on canvas
				let x = 0,
					y = 0;
				spriteImages.forEach((img) => {
					spriteCtx.drawImage(img, x, y);
					if (layout === "horizontal") {
						x += img.width + margin;
					} else {
						y += img.height + margin;
					}
				});

				// Create download link
				let downloadLink = document.getElementById("download-sprite");
				downloadLink.href = spriteCanvas.toDataURL("image/png");
				downloadLink.download = "sprite.png";
				downloadLink.style.display = "block";
			}

			function updateLayoutPreview() {
				// Optionally, implement a live preview of the layout
			}

			// Initial call to update the layout preview
			updateLayoutPreview();
		</script>
	</body>
</html>
